---
title: "Untitled"
author: "Andrew Causer"
date: "2025-12-17"
output: html_document
---


# Fig2E

Using an object generated in the ['Spatial Metabolic Analysis'](https://genomicsmachinelearning.github.io/SpaMTP/articles/Mouse_Urinary_Bladder.html#:~:text=by%20each%20cluster.-,%23%20Compute%20counts%20of%20Lipid%20Maps%20Categories%20for%20%27Up%27%20and%20%27Down%27%20entries,-category_counts%20%3C%2D%20UP) the code below was used to generate Figure 2E. 

```{r, include = FALSE}
## The below code was used to generate the cirlce plot in the SpaMTP publication

normalize_lipid_class <- function(lipid_class) {
  if (lipid_class %in% c("PC; PE-NMe; PE", "PC; PE; PE-NMe", "PC; PE; PE-NMe2")) {
    return("PC; PE; PE-NMe")
  } else {
    return(lipid_class)
  }
}

# Apply the normalization and replace semicolons with "or"
df <- category_counts %>%
  mutate(
    Lipid.Maps.Main.Class = sapply(Lipid.Maps.Main.Class, normalize_lipid_class),
    Lipid.Maps.Main.Class = gsub(";", " or ", Lipid.Maps.Main.Class),
    Lipid.Maps.Category = sapply(Lipid.Maps.Category, normalize_lipid_class),
    Lipid.Maps.Category = gsub(";", " or ", Lipid.Maps.Category)
  )

df <- df[c(1:8,11:14),]
df[8,]$count <- 4

category_counts <- df
empty_bar <- 2
to_add <- data.frame(matrix(NA, empty_bar*nlevels(category_counts$cluster), ncol(category_counts)) )
colnames(to_add) <- colnames(category_counts)
to_add$cluster <- rep(levels(category_counts$cluster), each=empty_bar)
category_counts <- rbind(category_counts, to_add)
category_counts <- category_counts %>% arrange(cluster)
category_counts$id <- seq(1, nrow(category_counts))

# Get the name and the y position of each label
label_data <- category_counts
number_of_bar <- nrow(label_data)
angle <- 90 - 360 * (label_data$id-0.5) /number_of_bar     # I substract 0.5 because the letter must have the angle of the center of the bars. Not extreme right(1) or extreme left (0)
label_data$hjust <- ifelse( angle < -90, 1, 0)
label_data$angle <- ifelse(angle < -90, angle+180, angle)

base_data <- category_counts %>%
  dplyr::group_by(cluster) %>%
  dplyr::summarize(start=min(id), end=max(id) - empty_bar) %>%
  dplyr::rowwise() %>%
  mutate(title=mean(c(start, end)))

p <- ggplot(category_counts,aes(fill=cluster, y=count, x=id))+
    geom_bar(stat = "identity")+
   xlim(0,dim(category_counts)[1])+ylim(-10,10)+geom_text(data=label_data, aes(x=id, y = count+1,label=Lipid.Maps.Main.Class),size = 4, angle = label_data$angle)+
    geom_segment(data=base_data, aes(x = start, y = -3, xend = end+1, yend = -3), alpha=0.8, size=2 , inherit.aes = FALSE)+
    geom_text(data=base_data, aes(x = title, y = -1, label=cluster), alpha=0.8, size=4, fontface="bold", inherit.aes = FALSE)+
     coord_polar()+theme_minimal()+
  theme(axis.text = element_blank(),axis.title = element_blank(),panel.grid = element_blank())

p
```
