---
title: "Benchmarking"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Benchmarking}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(SpaMTP)
```

## Pathway Analysis Benchmarking

Load data, run DE and ***SpaMTP*** pathway analysis
```{r}

## Load Data
striatum.dhb.data <- readRDS("vignette_data_files/Mouse_Brain/DHB_data/striatum.dhb.data.RDS")

## Generate differentially expressed genes/metabolites
Idents(striatum.dhb.data) <- "striatum"
deg =  FindAllMarkers(striatum.dhb.data , test.use = "wilcox_limma", assay = "SPT",only.pos =F)
dem =  FindAllMarkers(striatum.dhb.data , assay = "SPM", only.pos =T)

DE.list = list("genes" = deg,"metabolites" = dem)

## Run multi-modal pathway analysis for SpaMTP
regpathway = FindRegionalPathways(
  striatum.dhb.data,
  analyte_types = c("genes", "metabolites"),
  SM_slot = "counts", ST_slot = "counts",
  ident = "striatum",
  DE.list = DE.list
)

## Get list of significant genes and metabolite HMDB ID's for MetaboAnalyst Benchmarking (Joint Pathway Analysis)
## https://www.metaboanalyst.ca/MetaboAnalyst/upload/PathUploadView.xhtml 
dem$ids <- striatum.dhb.data@assays$SPM@meta.data[striatum.dhb.data@assays$SPM@meta.data$mz_names %in% dem$gene,]$all_Isomers
dems <- dem[dem$cluster == "intact",]
dems <- dems[dems$p_val_adj < 0.05,]
dems <- dems[dems$ids != "No Annotation",]

dems <- dems %>%
    tidyr::separate_rows(ids, sep = "; ")

degs = deg[deg$cluster == "intact",][deg[deg$cluster == "intact",]$p_val_adj < 0.05,]
#write.csv(dems, "../Benchmarking_DE_Metabolite_IDs.csv")
#write.csv(degs, "../Benchmarking_DE_genes.csv")



library(UpSetR)
upset_results <- c(
  SpaMTP = 164,
  MetaboAnalyst = 21,
  #IPA = ,
  Detected.Dopamine.Pathways = 2, 
  "SpaMTP&MetaboAnalyst" = 6,
  "SpaMTP&All.Detected.Dopamine.Pathways" = 2
 # "IPA" = 
)
  



upset(fromExpression(upset_results), 
      nintersects = 40, 
      nsets = 6, 
      order.by = "freq", 
      decreasing = T, 
      mb.ratio = c(0.6, 0.4),
      number.angles = 0, 
      text.scale = 1.1, 
      point.size = 2.8, 
      line.size = 1
)



```

